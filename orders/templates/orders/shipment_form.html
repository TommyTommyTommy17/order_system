<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>出荷入力 - 業務管理システム</title>
    <style>
        /* 全体のスタイル設定 */
        body { 
            background-color: #1a1a1a; 
            color: #e0e0e0; 
            font-family: "Meiryo", sans-serif; 
            margin: 0; 
            padding: 10px; 
            font-size: 0.85em; 
        }
        .form-container { 
            background-color: #262626; 
            padding: 15px; 
            border-radius: 8px; 
            max-width: 1400px; 
            margin: auto; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
        }
        h2 { 
            border-left: 5px solid #ff8c00; 
            padding-left: 10px; 
            margin: 0 0 10px 0; 
            font-size: 1.2em; 
            color: white; 
        }
        
        /* セクションごとのボックス設定 */
        .section-box { 
            border: 1px solid #444; 
            padding: 10px; 
            border-radius: 4px; 
            margin-bottom: 8px; 
            background: #333; 
        }
        .section-title { 
            font-weight: bold; 
            color: #ff8c00; 
            margin-bottom: 5px; 
            font-size: 0.85em; 
            border-bottom: 1px solid #444; 
        }

        /* グリッドレイアウトの定義 */
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .grid-6 { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .grid-7 { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        
        .field { display: flex; flex-direction: column; }
        label { 
            font-size: 0.8em; 
            color: #aaa; 
            margin-bottom: 2px; 
            font-weight: bold; 
        }
        
        /* 入力パーツ：背景白・文字黒 */
        input, select, textarea { 
            background-color: #ffffff !important; 
            border: 1px solid #999; 
            color: #000000 !important; 
            padding: 4px 8px; 
            border-radius: 3px; 
            font-size: 1.1em; 
            outline: none;
        }
        
        /* 読み取り専用項目：グレー背景・水色文字 */
        .readonly-field { 
            background-color: #222 !important; 
            color: #00ffcc !important; 
            font-weight: bold; 
            border: 1px solid #444; 
        }
        /* 受注コピー項目：非活性用グレー */
        .disabled-info { 
            background-color: #444 !important; 
            color: #bbb !important; 
            border: 1px solid #555; 
        }

        /* 下部アクションボタン */
        .btn-area { 
            display: flex; 
            gap: 15px; 
            margin-top: 10px; 
        }
        .btn { 
            flex: 1; 
            padding: 12px; 
            border-radius: 4px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 1.2em; 
            border: none; 
            transition: 0.2s; 
        }
        .btn-save { background-color: #ff8c00; color: white; }
        .btn-cancel { 
            background-color: #555; 
            color: white; 
            text-align: center; 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .btn:hover { opacity: 0.8; }

        /* チェックボックスの並び */
        .checkbox-group { 
            display: flex; 
            gap: 20px; 
            margin: 5px 0; 
            padding: 5px; 
            background: #2a2a2a; 
            border-radius: 4px; 
        }
        .checkbox-item { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            font-weight: bold; 
        }
    </style>
</head>
<body>

<div class="form-container">
    <h2>出荷入力</h2>
    <form method="post" id="shipmentForm">
        {% csrf_token %}

        <div class="section-box" style="background: #2a2a2a;">
            <div class="grid-3">
                <div class="field">
                    <label>契約NO</label>
                    <input type="text" name="issue_no" value="{{ form.initial.issue_no }}" class="readonly-field" readonly>
                </div>
                <div class="field">
                    <label>契約数量</label>
                    <input type="text" value="{{ form.initial.contract_qty }} m³" class="readonly-field" readonly>
                    <input type="hidden" name="contract_qty" value="{{ form.initial.contract_qty }}">
                </div>
                <div class="field">
                    <label>残量 (現時点)</label>
                    <input type="text" value="{{ form.initial.remaining_qty }} m³" class="readonly-field" readonly>
                    <input type="hidden" name="remaining_qty" value="{{ form.initial.remaining_qty }}">
                </div>
            </div>
        </div>

        <div class="section-box" style="border: 2px solid #ff8c00;">
            <div class="grid-7">
                <div class="field">
                    <label style="color: #ff8c00;">出荷日 *</label>
                    {{ form.ship_date }}
                </div>
                <div class="field">
                    <label style="color: #ff8c00;">車両番号 *</label>
                    {{ form.car_no }}
                </div>
                <div class="field">
                    <label style="color: #ff8c00;">出荷時間 *</label>
                    {{ form.ship_time }}
                </div>
                <div class="field">
                    <label>累計台数</label>
                    <input type="text" value="{{ form.initial.total_unit }}" class="readonly-field" readonly>
                    <input type="hidden" name="total_unit" value="{{ form.initial.total_unit }}">
                </div>
                <div class="field">
                    <label>前車No</label>
                    <input type="text" value="{{ form.initial.before_car_no|default:'なし' }}" class="readonly-field" readonly>
                    <input type="hidden" name="before_car_no" value="{{ form.initial.before_car_no }}">
                </div>
                <div class="field">
                    <label style="color: #ff8c00;">出荷量 *</label>
                    {{ form.ship_qty }}
                </div>
                <div class="field">
                    <label>累計出荷量</label>
                    <input type="text" value="{{ form.initial.total_ship_qty }} m³" class="readonly-field" readonly>
                    <input type="hidden" name="total_ship_qty" value="{{ form.initial.total_ship_qty }}">
                </div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">現場・取引先情報（受注データコピー）</div>
            <div class="grid-4">
                <div class="field"><label>現場名</label><input type="text" value="{{ form.initial.site }}" class="disabled-info" readonly></div>
                <div class="field"><label>現場住所</label><input type="text" value="{{ form.initial.site_address }}" class="disabled-info" readonly></div>
                <div class="field"><label>得意先</label><input type="text" value="{{ form.initial.customer }}" class="disabled-info" readonly></div>
                <div class="field"><label>施工者名</label><input type="text" value="{{ form.initial.contractor }}" class="disabled-info" readonly></div>
                <div class="field"><label>担当者名</label><input type="text" value="{{ form.initial.coordinator }}" class="disabled-info" readonly></div>
                <div class="field"><label>連絡先</label><input type="text" value="{{ form.initial.contact }}" class="disabled-info" readonly></div>
                <div class="field"><label>商品名</label><input type="text" value="{{ form.initial.product }}" class="disabled-info" readonly></div>
                <div class="field"><label>標準/規格</label><input type="text" value="{{ form.initial.product_category }}" class="disabled-info" readonly></div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">配合詳細・予定・単価</div>
            <div class="grid-6">
                <div class="field"><label>予定回転数</label>{{ form.rotation }}</div>
                <div class="field"><label>販売単価</label>{{ form.price }}</div>
                <div class="field"><label>原料土</label>{{ form.material_soil }}</div>
                <div class="field"><label>水</label>{{ form.water }}</div>
                <div class="field"><label>セメントBB</label>{{ form.cementBB }}</div>
                <div class="field"><label>再生砂</label>{{ form.recycle_sand }}</div>
                <div class="field"><label>混和剤</label>{{ form.admixture }}</div>
                <div class="field"><label>原料土wm</label>{{ form.material_soil_wm }}</div>
            </div>
        </div>

        <div class="section-box">
            <div class="checkbox-group">
                <div class="checkbox-item"><label>{{ form.test }} 現場試験</label></div>
                <div class="checkbox-item"><label>{{ form.night }} 夜間</label></div>
                <div class="checkbox-item"><label>{{ form.outside23 }} 23区外</label></div>
                <div class="checkbox-item"><label>{{ form.material_delivery }} 材料渡し</label></div>
            </div>
            <div class="grid-3" style="margin-top: 5px;">
                <div class="field"><label>備考</label>{{ form.note }}</div>
                <div class="field"><label>特記事項</label>{{ form.specialnote }}</div>
            </div>
        </div>

        <div style="display:none;">
            {{ form.site }}{{ form.site_address }}{{ form.customer }}{{ form.contractor }}
            {{ form.coordinator }}{{ form.contact }}{{ form.product }}{{ form.product_category }}
        </div>

        <div class="btn-area">
            <button type="button" class="btn btn-cancel" onclick="history.back()">取り消し (戻る)</button>
            <button type="submit" class="btn btn-save">出荷を確定して保存</button>
        </div>
    </form>
</div>

<script>
    /**
     * 保存成功時の通知と「受注案件一覧」へのリダイレクト
     */
    {% if saved_success %}
        alert("保存しました。");
        // 受注一覧のURL（name='order_list'）へ確実に遷移
        window.location.href = "{% url 'order_list' %}";
    {% endif %}

    /**
     * キーボード操作：Enterキーで次の入力欄へ移動
     */
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            const form = e.target.form;
            const index = Array.prototype.indexOf.call(form, e.target);
            if (form.elements[index + 1]) {
                form.elements[index + 1].focus();
            }
        }
    });
</script>
</body>
</html>